/*
    Consolidated YARA Rules for Endpoint Malware Detection

    Sources:
    - YARA-Rules Community (https://github.com/Yara-Rules/rules)
    - Neo23x0 Signature Base (https://github.com/Neo23x0/signature-base)
    - Elastic Security (https://github.com/elastic/protections-artifacts)
    - Community contributions

    Last Updated: 2024
*/

//=============================================================================
// TESTING
//=============================================================================

rule EICAR_Test_File {
    meta:
        description = "EICAR antivirus test file - safe for testing"
        reference = "https://www.eicar.org/"
        category = "test"
        severity = "low"
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    condition:
        $eicar
}

//=============================================================================
// CREDENTIAL THEFT TOOLS
//=============================================================================

rule Mimikatz_Strings {
    meta:
        description = "Detects Mimikatz credential dumping tool"
        author = "Florian Roth"
        reference = "https://github.com/gentilkiwi/mimikatz"
        mitre_attack = "T1003"
        severity = "critical"
    strings:
        $s1 = "sekurlsa::logonpasswords" ascii wide nocase
        $s2 = "sekurlsa::wdigest" ascii wide nocase
        $s3 = "sekurlsa::kerberos" ascii wide nocase
        $s4 = "lsadump::sam" ascii wide nocase
        $s5 = "lsadump::dcsync" ascii wide nocase
        $s6 = "mimilib.dll" ascii wide
        $s7 = "mimidrv.sys" ascii wide
        $s8 = "gentilkiwi" ascii wide
        $s9 = "benjamin@gentilkiwi.com" ascii wide
        $s10 = "kiwi" ascii wide
        $s11 = "mimikatz" ascii wide nocase
    condition:
        2 of them
}

rule LaZagne_Credential_Dumper {
    meta:
        description = "Detects LaZagne credential recovery tool"
        reference = "https://github.com/AlessandroZ/LaZagne"
        mitre_attack = "T1555"
        severity = "critical"
    strings:
        $s1 = "lazagne" ascii wide nocase
        $s2 = "laZagne" ascii wide
        $s3 = "credman" ascii wide nocase
        $s4 = "retrieve all passwords" ascii wide nocase
    condition:
        2 of them
}

rule SecretsDump_Impacket {
    meta:
        description = "Detects Impacket secretsdump tool"
        reference = "https://github.com/SecureAuthCorp/impacket"
        mitre_attack = "T1003"
        severity = "critical"
    strings:
        $s1 = "secretsdump" ascii wide nocase
        $s2 = "impacket" ascii wide nocase
        $s3 = "NTDS.DIT" ascii wide
        $s4 = "drsuapi" ascii wide nocase
    condition:
        2 of them
}

//=============================================================================
// COMMAND AND CONTROL FRAMEWORKS
//=============================================================================

rule CobaltStrike_Beacon_Strings {
    meta:
        description = "Detects Cobalt Strike Beacon payload"
        author = "Elastic Security"
        mitre_attack = "T1071"
        severity = "critical"
    strings:
        $s1 = "%s (admin)" ascii
        $s2 = "beacon.dll" ascii
        $s3 = "beacon.x64.dll" ascii
        $s4 = "%s as %s\\%s: %d" ascii
        $s5 = "ReflectiveLoader" ascii
        $s6 = "www6telecom" ascii
        $s7 = "$http-get" ascii
        $s8 = "$http-post" ascii
        $s9 = "sleeptime" ascii
        $s10 = "jitter" ascii
    condition:
        3 of them
}

rule CobaltStrike_Malleable_C2 {
    meta:
        description = "Detects Cobalt Strike Malleable C2 indicators"
        mitre_attack = "T1071.001"
        severity = "critical"
    strings:
        $s1 = "set sleeptime" ascii
        $s2 = "set jitter" ascii
        $s3 = "set useragent" ascii
        $s4 = "http-get {" ascii
        $s5 = "http-post {" ascii
        $s6 = "stage {" ascii
    condition:
        3 of them
}

rule Metasploit_Meterpreter {
    meta:
        description = "Detects Metasploit Meterpreter payload"
        reference = "https://github.com/rapid7/metasploit-framework"
        mitre_attack = "T1059"
        severity = "critical"
    strings:
        $s1 = "meterpreter" ascii wide nocase
        $s2 = "stdapi" ascii
        $s3 = "priv_" ascii
        $s4 = "core_channel" ascii
        $s5 = "reverse_tcp" ascii nocase
        $s6 = "reverse_http" ascii nocase
        $s7 = "bind_tcp" ascii nocase
    condition:
        3 of them
}

rule PowerShell_Empire {
    meta:
        description = "Detects PowerShell Empire framework"
        reference = "https://github.com/BC-SECURITY/Empire"
        mitre_attack = "T1059.001"
        severity = "critical"
    strings:
        $s1 = "Invoke-Empire" ascii wide nocase
        $s2 = "Invoke-Shellcode" ascii wide nocase
        $s3 = "Invoke-Mimikatz" ascii wide nocase
        $s4 = "Get-GPPPassword" ascii wide nocase
        $s5 = "Invoke-TokenManipulation" ascii wide nocase
        $s6 = "Invoke-CredentialInjection" ascii wide nocase
        $s7 = "Invoke-ReflectivePEInjection" ascii wide nocase
        $s8 = "powershell/situational" ascii wide nocase
    condition:
        any of them
}

rule Sliver_C2_Framework {
    meta:
        description = "Detects Sliver C2 framework"
        reference = "https://github.com/BishopFox/sliver"
        mitre_attack = "T1071"
        severity = "critical"
    strings:
        $s1 = "sliver" ascii wide nocase
        $s2 = "bishopfox" ascii wide nocase
        $s3 = "sliverpb" ascii
        $s4 = "GetSystem" ascii
        $s5 = "Impersonate" ascii
    condition:
        2 of them
}

//=============================================================================
// RANSOMWARE
//=============================================================================

rule Ransomware_Note_Generic {
    meta:
        description = "Detects generic ransomware note indicators"
        mitre_attack = "T1486"
        severity = "critical"
    strings:
        $ransom1 = "your files have been encrypted" ascii wide nocase
        $ransom2 = "all your files are encrypted" ascii wide nocase
        $ransom3 = "pay the ransom" ascii wide nocase
        $ransom4 = "decrypt your files" ascii wide nocase
        $ransom5 = "restore your files" ascii wide nocase
        $ransom6 = "files will be deleted" ascii wide nocase

        $payment1 = "bitcoin" ascii wide nocase
        $payment2 = "btc" ascii wide nocase
        $payment3 = "monero" ascii wide nocase
        $payment4 = "cryptocurrency" ascii wide nocase
        $payment5 = "wallet" ascii wide nocase

        $contact1 = ".onion" ascii wide nocase
        $contact2 = "tor browser" ascii wide nocase
        $contact3 = "contact us" ascii wide nocase
        $contact4 = "protonmail" ascii wide nocase
    condition:
        (2 of ($ransom*)) and (1 of ($payment*) or 1 of ($contact*))
}

rule Ransomware_Extension_Changer {
    meta:
        description = "Detects ransomware file extension patterns"
        mitre_attack = "T1486"
        severity = "high"
    strings:
        $s1 = ".encrypted" ascii wide nocase
        $s2 = ".locked" ascii wide nocase
        $s3 = ".crypted" ascii wide nocase
        $s4 = ".enc" ascii wide nocase
        $s5 = "HOW_TO_DECRYPT" ascii wide nocase
        $s6 = "HOW_TO_RECOVER" ascii wide nocase
        $s7 = "DECRYPT_INSTRUCTION" ascii wide nocase
        $s8 = "README_FOR_DECRYPT" ascii wide nocase
    condition:
        2 of them
}

//=============================================================================
// WEBSHELLS
//=============================================================================

rule WebShell_PHP_Generic {
    meta:
        description = "Detects generic PHP webshell patterns"
        mitre_attack = "T1505.003"
        severity = "high"
    strings:
        $php = "<?php" ascii nocase

        $eval1 = "eval($_" ascii nocase
        $eval2 = "eval(base64_decode" ascii nocase
        $eval3 = "eval(gzinflate" ascii nocase
        $eval4 = "eval(str_rot13" ascii nocase
        $eval5 = "assert($_" ascii nocase

        $exec1 = "system($_" ascii nocase
        $exec2 = "shell_exec($_" ascii nocase
        $exec3 = "passthru($_" ascii nocase
        $exec4 = "exec($_" ascii nocase
        $exec5 = "popen($_" ascii nocase
        $exec6 = "proc_open(" ascii nocase
    condition:
        $php and (any of ($eval*) or any of ($exec*))
}

rule WebShell_ASPX_Generic {
    meta:
        description = "Detects generic ASPX webshell patterns"
        mitre_attack = "T1505.003"
        severity = "high"
    strings:
        $aspx = "<%@ Page" ascii nocase

        $s1 = "cmd.exe" ascii nocase
        $s2 = "powershell" ascii nocase
        $s3 = "Process.Start" ascii nocase
        $s4 = "ProcessStartInfo" ascii nocase
        $s5 = "Request.Form" ascii nocase
        $s6 = "Request.QueryString" ascii nocase
        $s7 = "Server.Execute" ascii nocase
    condition:
        $aspx and 2 of ($s*)
}

rule WebShell_JSP_Generic {
    meta:
        description = "Detects generic JSP webshell patterns"
        mitre_attack = "T1505.003"
        severity = "high"
    strings:
        $jsp1 = "<%@" ascii
        $jsp2 = "<%=" ascii

        $exec1 = "Runtime.getRuntime().exec" ascii
        $exec2 = "ProcessBuilder" ascii
        $exec3 = "getParameter" ascii
        $exec4 = "/bin/sh" ascii
        $exec5 = "cmd /c" ascii nocase
    condition:
        any of ($jsp*) and 2 of ($exec*)
}

rule WebShell_China_Chopper {
    meta:
        description = "Detects China Chopper webshell"
        reference = "https://www.fireeye.com/blog/threat-research/2013/08/breaking-down-the-china-chopper-web-shell-part-i.html"
        mitre_attack = "T1505.003"
        severity = "critical"
    strings:
        $s1 = "eval(Request" ascii nocase
        $s2 = "FromBase64String" ascii
        $s3 = "@eval($_POST" ascii nocase
        $s4 = "z1" ascii
        $s5 = "z2" ascii
        $chopper = /[a-zA-Z0-9+\/]{50,}=/ ascii
    condition:
        2 of ($s*) or ($chopper and any of ($s*))
}

//=============================================================================
// REVERSE SHELLS
//=============================================================================

rule Reverse_Shell_PowerShell {
    meta:
        description = "Detects PowerShell reverse shell patterns"
        mitre_attack = "T1059.001"
        severity = "high"
    strings:
        $tcp1 = "System.Net.Sockets.TCPClient" ascii wide nocase
        $tcp2 = "Net.Sockets.TcpClient" ascii wide nocase
        $tcp3 = "TCPClient(" ascii wide

        $stream1 = "GetStream()" ascii wide
        $stream2 = "NetworkStream" ascii wide

        $read1 = "StreamReader" ascii wide
        $read2 = "StreamWriter" ascii wide

        $shell1 = "-e cmd" ascii wide nocase
        $shell2 = "cmd.exe" ascii wide nocase
        $shell3 = "powershell" ascii wide nocase
        $shell4 = "/bin/bash" ascii
        $shell5 = "/bin/sh" ascii
    condition:
        (any of ($tcp*) and any of ($stream*)) or (any of ($tcp*) and any of ($read*) and any of ($shell*))
}

rule Reverse_Shell_Netcat {
    meta:
        description = "Detects Netcat reverse shell usage"
        mitre_attack = "T1059"
        severity = "high"
    strings:
        $nc1 = "nc.exe" ascii wide nocase
        $nc2 = "ncat" ascii wide nocase
        $nc3 = "netcat" ascii wide nocase

        $flag1 = "-e cmd" ascii wide nocase
        $flag2 = "-e /bin" ascii
        $flag3 = "-c cmd" ascii wide nocase
        $flag4 = "-lvp" ascii
        $flag5 = "-nv" ascii
    condition:
        any of ($nc*) and any of ($flag*)
}

//=============================================================================
// SUSPICIOUS SCRIPTS
//=============================================================================

rule Suspicious_PowerShell_Download {
    meta:
        description = "Detects suspicious PowerShell download cradle"
        mitre_attack = "T1059.001"
        severity = "medium"
    strings:
        $dl1 = "Invoke-WebRequest" ascii wide nocase
        $dl2 = "wget " ascii wide nocase
        $dl3 = "curl " ascii wide nocase
        $dl4 = "Net.WebClient" ascii wide nocase
        $dl5 = "DownloadString" ascii wide nocase
        $dl6 = "DownloadFile" ascii wide nocase
        $dl7 = "Start-BitsTransfer" ascii wide nocase

        $exec1 = "IEX" ascii wide
        $exec2 = "Invoke-Expression" ascii wide nocase
        $exec3 = "-enc" ascii wide nocase
        $exec4 = "-EncodedCommand" ascii wide nocase
        $exec5 = "FromBase64String" ascii wide
        $exec6 = "[Convert]::" ascii wide
    condition:
        any of ($dl*) and any of ($exec*)
}

rule Suspicious_Batch_Script {
    meta:
        description = "Detects suspicious batch script patterns"
        mitre_attack = "T1059.003"
        severity = "medium"
    strings:
        $batch = "@echo off" ascii nocase

        $s1 = "reg add" ascii nocase
        $s2 = "reg delete" ascii nocase
        $s3 = "schtasks /create" ascii nocase
        $s4 = "net user" ascii nocase
        $s5 = "net localgroup" ascii nocase
        $s6 = "wmic" ascii nocase
        $s7 = "vssadmin delete shadows" ascii nocase
        $s8 = "bcdedit" ascii nocase
        $s9 = "wbadmin delete" ascii nocase
    condition:
        $batch and 3 of ($s*)
}

rule Suspicious_VBA_Macro {
    meta:
        description = "Detects suspicious VBA macro patterns"
        mitre_attack = "T1204.002"
        severity = "medium"
    strings:
        $vba = "Sub " ascii wide

        $auto1 = "AutoOpen" ascii wide nocase
        $auto2 = "Auto_Open" ascii wide nocase
        $auto3 = "Document_Open" ascii wide nocase
        $auto4 = "Workbook_Open" ascii wide nocase
        $auto5 = "AutoExec" ascii wide nocase

        $sus1 = "Shell" ascii wide
        $sus2 = "WScript.Shell" ascii wide
        $sus3 = "powershell" ascii wide nocase
        $sus4 = "cmd.exe" ascii wide nocase
        $sus5 = "CreateObject" ascii wide
        $sus6 = "URLDownloadToFile" ascii wide nocase
        $sus7 = "XMLHTTP" ascii wide
        $sus8 = "ADODB.Stream" ascii wide
    condition:
        $vba and any of ($auto*) and 2 of ($sus*)
}

//=============================================================================
// PACKED / OBFUSCATED EXECUTABLES
//=============================================================================

rule Packed_UPX {
    meta:
        description = "Detects UPX packed executable"
        mitre_attack = "T1027.002"
        severity = "low"
    strings:
        $mz = { 4D 5A }
        $upx1 = "UPX0" ascii
        $upx2 = "UPX1" ascii
        $upx3 = "UPX!" ascii
    condition:
        $mz at 0 and any of ($upx*)
}

rule Packed_Generic {
    meta:
        description = "Detects potentially packed or obfuscated executable"
        mitre_attack = "T1027.002"
        severity = "low"
    strings:
        $mz = { 4D 5A }
        $pack1 = ".aspack" ascii
        $pack2 = ".adata" ascii
        $pack3 = "ASPack" ascii
        $pack4 = "FSG!" ascii
        $pack5 = "PECompact" ascii
        $pack6 = "Themida" ascii
        $pack7 = "VMProtect" ascii
        $pack8 = "Enigma" ascii
    condition:
        $mz at 0 and any of ($pack*)
}

//=============================================================================
// HACKTOOL UTILITIES
//=============================================================================

rule HackTool_PsExec {
    meta:
        description = "Detects PsExec or similar remote execution tools"
        mitre_attack = "T1569.002"
        severity = "medium"
    strings:
        $s1 = "psexec" ascii wide nocase
        $s2 = "psexesvc" ascii wide nocase
        $s3 = "paexec" ascii wide nocase
        $s4 = "remcom" ascii wide nocase
        $s5 = "PSEXESVC" ascii wide
    condition:
        any of them
}

rule HackTool_ProcessHollowing {
    meta:
        description = "Detects process hollowing indicators"
        mitre_attack = "T1055.012"
        severity = "high"
    strings:
        $api1 = "NtUnmapViewOfSection" ascii
        $api2 = "ZwUnmapViewOfSection" ascii
        $api3 = "NtMapViewOfSection" ascii
        $api4 = "WriteProcessMemory" ascii
        $api5 = "SetThreadContext" ascii
        $api6 = "ResumeThread" ascii
        $api7 = "CreateProcessA" ascii
        $api8 = "CreateProcessW" ascii
        $sus = "CREATE_SUSPENDED" ascii
    condition:
        4 of ($api*) and $sus
}

rule HackTool_Rubeus {
    meta:
        description = "Detects Rubeus Kerberos toolkit"
        reference = "https://github.com/GhostPack/Rubeus"
        mitre_attack = "T1558"
        severity = "critical"
    strings:
        $s1 = "Rubeus" ascii wide
        $s2 = "asktgt" ascii wide nocase
        $s3 = "asktgs" ascii wide nocase
        $s4 = "kerberoast" ascii wide nocase
        $s5 = "s4u" ascii wide nocase
        $s6 = "createnetonly" ascii wide nocase
        $s7 = "ptt" ascii wide nocase
    condition:
        $s1 or 3 of them
}

rule HackTool_SharpHound {
    meta:
        description = "Detects SharpHound/BloodHound collection tool"
        reference = "https://github.com/BloodHoundAD/SharpHound"
        mitre_attack = "T1087"
        severity = "high"
    strings:
        $s1 = "SharpHound" ascii wide
        $s2 = "BloodHound" ascii wide
        $s3 = "CollectionMethod" ascii wide
        $s4 = "Invoke-BloodHound" ascii wide nocase
        $s5 = "bloodhound.bin" ascii wide nocase
    condition:
        2 of them
}
